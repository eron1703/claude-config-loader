# CI/CD Pipeline Configuration
#
# Document all CI/CD pipelines, deployments, and automation

pipelines:
  # Example structure:
  # project_name:
  #   platform: github_actions | gitlab_ci | jenkins
  #   config_file: .github/workflows/ci.yml
  #   triggers:
  #     - push to main
  #     - pull requests
  #   stages:
  #     - lint
  #     - test
  #     - build
  #     - deploy
  #   environments:
  #     staging: auto-deploy on merge to main
  #     production: manual approval required

  resolver:
    platform: github_actions
    config_file: .github/workflows/ci.yml
    triggers:
      - "Push to main"
      - "Pull requests"
    stages:
      - lint
      - test
      - build
    notes: "Local development via Docker Compose, uses NetBox and ArangoDB"

  commander:
    platform: github_actions
    config_file: .github/workflows/ci.yml (if exists)
    repo: https://github.com/HCB-Consulting-ME/flow-commander
    triggers:
      - "Push to main"
      - "Pull requests"
    stages:
      - lint
      - test
      - build
      - docker-build
    notes: "HCB-Consulting-ME org repo, modular architecture with workers"

  flowmaster-microservices:
    platform: gitlab_ci
    config_file: .gitlab-ci.yml
    repo: gitlab.com/flow-master/* (multiple repos per microservice)
    primary_repos:
      - "gitlab.com/flow-master/flowmaster-engage"
      - "Individual service repos with GitLab CI"
    triggers:
      - "Push to develop branch → auto-deploy to dev server (65.21.153.235)"
      - "Push to staging branch → auto-deploy to staging server (91.98.159.56)"
      - "Push to main branch → MANUAL deploy to production server (91.99.237.14)"
    stages:
      - test (Python: black, flake8, pytest)
      - build (Docker image build)
      - deploy (SSH deploy to target server)
    deployment_targets:
      develop:
        server: "65.21.153.235 (DEV_SERVER)"
        path: "/opt/<project>-develop/"
        trigger: "Auto-deploy on push to develop"
        runtime: "Docker containers (K3S available but services use Docker)"
      staging:
        server: "91.98.159.56 (STAGING_SERVER)"
        path: "/opt/<project>-staging/"
        domain: "staging.flow-master.ai"
        trigger: "Auto-deploy on push to staging"
        runtime: "Docker Compose"
      production:
        server: "91.99.237.14 (PRODUCTION_SERVER)"
        path: "/opt/<project>/"
        domain: "app.flow-master.ai"
        trigger: "MANUAL approval required (when: manual)"
        runtime: "Docker Compose"
    ci_variables:
      - "SSH_PRIVATE_KEY (deploy key)"
      - "DEV_SERVER=65.21.153.235"
      - "STAGING_SERVER=91.98.159.56"
      - "PRODUCTION_SERVER=91.99.237.14"
    gitlab_runner:
      name: "flowmaster-demo-runner"
      location: "65.21.153.235 (dev server)"
      executor: "docker"
      tags: ["docker", "demo-server"]
      version: "18.8.0"
    service_ports:
      api_gateway: 9000
      auth_service: 9001
      document_intelligence: 9002
      process_design: 9003
      human_task: 9006
      ai_agent: 9007
      scheduling: 9008
      frontend: 9009
      websocket_gateway: 9010
      notification: 9011
    notes: |
      - Each microservice has its own GitLab CI/CD pipeline
      - develop → dev server (65.21.153.235) — auto-deploy
      - staging → staging server (91.98.159.56) — auto-deploy
      - main → production server (91.99.237.14) — MANUAL deploy only
      - GitLab Runner runs on dev server (65.21.153.235)
      - Dev server uses Docker containers (K3S cluster also present)
      - Staging/Production use Docker Compose

  dxg:
    platform: github_actions
    config_file: .github/workflows/ci.yml (if exists)
    repo: https://github.com/HCB-Consulting-ME/dxg
    triggers:
      - "Push to main"
      - "Pull requests"
    stages:
      - lint
      - test
      - build
    notes: "Python backend with pytest, React frontend"

  sdx:
    platform: github_actions
    config_file: .github/workflows/ci.yml (if exists)
    repo: https://github.com/HCB-Consulting-ME/sdx
    triggers:
      - "Push to main"
      - "Pull requests"
    stages:
      - lint
      - test
      - build
    notes: "Secure data exchange, uses external ArangoDB"

# Deployment Targets — 3-Environment Model
#
# DEV:        65.21.153.235  — auto-deploy develop branch, GitLab Runner lives here
# STAGING:    91.98.159.56   — auto-deploy staging branch
# PRODUCTION: 91.99.237.14   — manual deploy main branch only
#
deployments:
  dev_server:
    platform: "Hetzner Cloud VPS (65.21.153.235)"
    method: "Docker containers (K3S cluster also available)"
    url: "http://65.21.153.235:9009 (flowmaster frontend)"
    trigger: "Auto-deploy on push to develop branch"
    deployment_paths:
      - "/opt/flowmaster-rebuild/ (FlowMaster microservices)"
      - "/opt/flowmaster-engage/ (engage project)"
      - "/opt/flowmaster-manager/ (management tools)"
      - "/opt/<project>-develop/ (new projects)"
    ports: "9000-9011 (FlowMaster microservices)"
    infrastructure:
      gitlab_runner: "flowmaster-demo-runner (docker executor, tags: docker, demo-server)"
      kubernetes: "K3S v1.34.3 (monitoring namespace: Grafana, Prometheus, Loki)"
      monitoring: "http://65.21.153.235:30080 (Grafana)"
      plane: "http://65.21.153.235:8083 (Plane CE v1.2.1)"
      agent_chat: "http://65.21.153.235:8099 (agent telemetry)"
    notes: |
      - PRIMARY DEVELOPMENT SERVER — all CI/CD develop branches deploy here
      - GitLab Runner runs here — executes all CI/CD jobs
      - Docker containers for services (NOT docker-compose for deployments)
      - K3S for monitoring stack (Grafana, Prometheus, Loki)
      - Plane project management deployed here
      - SSH: demo-server (root, key: ~/.ssh/demo_server)

  staging_server:
    platform: "Hetzner Cloud VPS (91.98.159.56)"
    method: docker_compose
    trigger: "Auto-deploy on push to staging branch"
    deployment_paths:
      - "/opt/flowmaster-microservices-staging/"
      - "/opt/<project>-staging/ (new projects)"
    domain: "staging.flow-master.ai"
    compose_file: "docker-compose.integration.yml"
    infrastructure:
      runtime: "Docker + Docker Compose"
      web_server: "Nginx (reverse proxy + SSL via Let's Encrypt)"
      gitlab_runner: "NONE — runner is on dev server"
    notes: |
      - STAGING ENVIRONMENT — staging branches auto-deploy here
      - Docker Compose for deployments
      - SSH: ms-dev (root, key: ~/.ssh/id_rsa)

  production_server:
    platform: "Hetzner Cloud VPS (91.99.237.14)"
    method: docker_compose
    url: "https://app.flow-master.ai"
    trigger: "MANUAL approval required (when: manual in GitLab CI)"
    deployment_paths:
      - "/opt/flowmaster-microservices/"
      - "/opt/<project>/ (new projects)"
    domain: "app.flow-master.ai"
    compose_file: "docker-compose.integration.yml"
    approval_required: true
    infrastructure:
      runtime: "Docker + Docker Compose"
      web_server: "Nginx (reverse proxy + SSL via Let's Encrypt)"
      other: "Dokku, Portainer (9443)"
    notes: |
      - PRODUCTION ENVIRONMENT — main branch manual deploy only
      - Also used as personal dev server (SSH alias: server/root-server)
      - SSH: server (ben) or root-server (root), key: ~/.ssh/eron1703_duckdns
      - Projects dir for manual work: /srv/projects/

  local:
    method: docker_compose
    trigger: "Manual: docker compose up"
    notes: "Local development via OrbStack on macOS (NOT Docker Desktop)"

# Secrets Management
secrets:
  # production:
  #   method: aws_secrets_manager | vault | github_secrets
  #   access: "See documentation in docs/secrets.md"
  #
  # staging:
  #   method: environment_variables
  #   access: "Set in CI/CD platform"

  local:
    method: .env files
    notes: "Each project has .env file (gitignored)"
    example: |
      # .env example
      ARANGO_PASSWORD=your_password_here
      API_KEY=your_api_key_here

# Monitoring & Alerts
monitoring:
  flowmaster_dev_server:
    platform: "Grafana + Prometheus + Loki"
    grafana_url: "http://65.21.153.235:30080"
    deployment: "Kubernetes (monitoring namespace)"
    dashboards:
      - "API Performance"
      - "Container Resources"
      - "Infrastructure Metrics"
      - "Application Logs (via Loki)"
    access: "Direct browser access, no auth required for viewing"
    notes: "Monitors FlowMaster microservices on dev server"

  plane_pm:
    platform: "Plane CE"
    url: "http://65.21.153.235:8083"
    deployment: "Docker Compose + Kubernetes"
    workspace: "flowmaster"
    project: "FM (FlowMaster)"
    mcp_server: "http://65.21.153.235:8012"
    notes: "Project management and task tracking for FlowMaster team"

# Best Practices
best_practices:
  - "Never commit secrets to git"
  - "Use environment variables for configuration"
  - "Test CI/CD changes in feature branches"
  - "Require code review before deployment"
  - "Have rollback plan for production deploys"
