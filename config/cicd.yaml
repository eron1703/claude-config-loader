# CI/CD Pipeline Configuration
#
# Document all CI/CD pipelines, deployments, and automation

pipelines:
  # Example structure:
  # project_name:
  #   platform: github_actions | gitlab_ci | jenkins
  #   config_file: .github/workflows/ci.yml
  #   triggers:
  #     - push to main
  #     - pull requests
  #   stages:
  #     - lint
  #     - test
  #     - build
  #     - deploy
  #   environments:
  #     staging: auto-deploy on merge to main
  #     production: manual approval required

  resolver:
    platform: github_actions
    config_file: .github/workflows/ci.yml
    triggers:
      - "Push to main"
      - "Pull requests"
    stages:
      - lint
      - test
      - build
    notes: "Local development via Docker Compose, uses NetBox and ArangoDB"

  commander:
    platform: github_actions
    config_file: .github/workflows/ci.yml (if exists)
    repo: https://github.com/HCB-Consulting-ME/flow-commander
    triggers:
      - "Push to main"
      - "Pull requests"
    stages:
      - lint
      - test
      - build
      - docker-build
    notes: "HCB-Consulting-ME org repo, modular architecture with workers"

  flowmaster-microservices:
    platform: gitlab_ci
    config_file: .gitlab-ci.yml
    repo: gitlab.com/flow-master/* (multiple repos per microservice)
    primary_repos:
      - "gitlab.com/flow-master/flowmaster-engage"
      - "Individual service repos with GitLab CI"
    triggers:
      - "Push to develop branch → auto-deploy to dev-01 (65.21.153.235)"
      - "Push to staging branch → auto-deploy to dev-02 (91.98.159.56)"
      - "Push to feature/* branch → auto-deploy to dev-03 (65.21.52.58)"
      - "Push to main branch → MANUAL deploy to prod-01 (91.99.237.14)"
    stages:
      - test (Python: black, flake8, pytest)
      - build (Docker image build)
      - deploy (SSH deploy to target server)
    deployment_targets:
      develop:
        server: "65.21.153.235 (dev-01)"
        path: "/opt/<project>-develop/"
        trigger: "Auto-deploy on push to develop"
        runtime: "Docker containers (K3S available but services use Docker)"
        databases: "Local ArangoDB, PostgreSQL, Redis"
      staging:
        server: "91.98.159.56 (dev-02)"
        path: "/opt/<project>-staging/"
        domain: "staging.flow-master.ai"
        trigger: "Auto-deploy on push to staging"
        runtime: "Docker Compose"
        databases: "Local ArangoDB, PostgreSQL, Redis"
      feature:
        server: "65.21.52.58 (dev-03)"
        path: "/opt/<project>-feature/"
        trigger: "Auto-deploy on push to feature/*"
        runtime: "Docker Compose"
        databases: "Local ArangoDB, PostgreSQL, Redis"
      production:
        server: "91.99.237.14 (prod-01)"
        path: "/opt/<project>/"
        domain: "app.flow-master.ai"
        trigger: "MANUAL approval required (when: manual)"
        runtime: "Docker Compose"
    branch_to_server_mapping:
      develop: "dev-01 (65.21.153.235)"
      staging: "dev-02 (91.98.159.56)"
      "feature/*": "dev-03 (65.21.52.58)"
      main: "prod-01 (91.99.237.14)"
    ci_variables:
      - "DEV_SERVER_01_IP=65.21.153.235"
      - "DEV_SERVER_02_IP=91.98.159.56"
      - "DEV_SERVER_03_IP=65.21.52.58"
      - "PROD_SERVER_IP=91.99.237.14"
      - "DEV_01_SSH_KEY (deploy key for dev-01, key: ~/.ssh/demo_server)"
      - "DEV_02_SSH_KEY (deploy key for dev-02, key: ~/.ssh/id_rsa)"
      - "DEV_03_SSH_KEY (deploy key for dev-03, key: ~/.ssh/demo_server)"
      - "PROD_SSH_KEY (deploy key for prod-01, key: ~/.ssh/eron1703_duckdns)"
    gitlab_runner:
      name: "flowmaster-demo-runner"
      location: "65.21.153.235 (dev-01)"
      executor: "docker"
      tags: ["docker", "dev-01"]
      version: "18.8.0"
    service_ports:
      api_gateway: 9000
      auth_service: 9001
      document_intelligence: 9002
      process_design: 9003
      human_task: 9006
      ai_agent: 9007
      scheduling: 9008
      frontend: 9009
      websocket_gateway: 9010
      notification: 9011
    notes: |
      - Each microservice has its own GitLab CI/CD pipeline
      - develop → dev-01 (65.21.153.235) — auto-deploy
      - staging → dev-02 (91.98.159.56) — auto-deploy
      - feature/* → dev-03 (65.21.52.58) — auto-deploy
      - main → prod-01 (91.99.237.14) — MANUAL deploy only
      - GitLab Runner runs on dev-01 (65.21.153.235)
      - All 3 dev servers have local databases (ArangoDB, PostgreSQL, Redis)
      - dev-01 uses Docker containers (K3S cluster also present)
      - dev-02, dev-03, prod-01 use Docker Compose

  dxg:
    platform: github_actions
    config_file: .github/workflows/ci.yml (if exists)
    repo: https://github.com/HCB-Consulting-ME/dxg
    triggers:
      - "Push to main"
      - "Pull requests"
    stages:
      - lint
      - test
      - build
    notes: "Python backend with pytest, React frontend"

  sdx:
    platform: github_actions
    config_file: .github/workflows/ci.yml (if exists)
    repo: https://github.com/HCB-Consulting-ME/sdx
    triggers:
      - "Push to main"
      - "Pull requests"
    stages:
      - lint
      - test
      - build
    notes: "Secure data exchange, uses external ArangoDB"

# Deployment Targets — 4-Server Model (3 Dev + 1 Prod)
#
# dev-01:  65.21.153.235  | Helsinki    | CCX23 | develop branch    | FlowMaster, Plane, Grafana, Agent Chat, GitLab Runner
# dev-02:  91.98.159.56   | Falkenstein | CCX23 | staging branch    | FlowMaster (staging/integration)
# dev-03:  65.21.52.58    | Helsinki    | CCX23 | feature/* branches | FlowMaster (feature branches, experiments)
# prod-01: 91.99.237.14   | Nuremberg   | CPX41 | main branch       | FlowMaster (production)
#
# Branch → Server Deployment Matrix:
#   develop   → dev-01 (auto-deploy)
#   staging   → dev-02 (auto-deploy)
#   feature/* → dev-03 (auto-deploy)
#   main      → prod-01 (MANUAL deploy only)
#
deployments:
  dev_01:
    platform: "Hetzner Cloud CCX23 (65.21.153.235, Helsinki)"
    method: "Docker containers (K3S cluster also available)"
    url: "http://65.21.153.235:9009 (flowmaster frontend)"
    trigger: "Auto-deploy on push to develop branch"
    deployment_paths:
      - "/opt/flowmaster-rebuild/ (FlowMaster microservices)"
      - "/opt/flowmaster-engage/ (engage project)"
      - "/opt/flowmaster-manager/ (management tools)"
      - "/opt/<project>-develop/ (new projects)"
    ports: "9000-9011 (FlowMaster microservices)"
    databases:
      - "ArangoDB (local, port 8529)"
      - "PostgreSQL (local, port 5433)"
      - "Redis (local, port 6380)"
    infrastructure:
      gitlab_runner: "flowmaster-demo-runner (docker executor, tags: docker, dev-01)"
      kubernetes: "K3S v1.34.3 (monitoring namespace: Grafana, Prometheus, Loki)"
      monitoring: "http://65.21.153.235:30080 (Grafana)"
      plane: "http://65.21.153.235:8083 (Plane CE v1.2.1)"
      agent_chat: "http://65.21.153.235:8099 (agent telemetry)"
    notes: |
      - PRIMARY DEV SERVER (dev-01) — develop branches auto-deploy here
      - Hosts: FlowMaster, Plane, Grafana, Agent Chat, GitLab Runner
      - GitLab Runner runs here — executes all CI/CD jobs
      - Docker containers for services (NOT docker-compose for deployments)
      - K3S for monitoring stack (Grafana, Prometheus, Loki)
      - Local databases: ArangoDB, PostgreSQL, Redis
      - SSH: dev-01 (root, key: ~/.ssh/demo_server)

  dev_02:
    platform: "Hetzner Cloud CCX23 (91.98.159.56, Falkenstein)"
    method: docker_compose
    trigger: "Auto-deploy on push to staging branch"
    deployment_paths:
      - "/opt/flowmaster-microservices-staging/"
      - "/opt/<project>-staging/ (new projects)"
    domain: "staging.flow-master.ai"
    compose_file: "docker-compose.integration.yml"
    databases:
      - "ArangoDB (local)"
      - "PostgreSQL (local)"
      - "Redis (local)"
    infrastructure:
      runtime: "Docker + Docker Compose"
      web_server: "Nginx (reverse proxy + SSL via Let's Encrypt)"
      gitlab_runner: "NONE — runner is on dev-01"
    notes: |
      - SECONDARY DEV (dev-02) — staging/integration testing
      - Hosts: FlowMaster (staging/integration testing)
      - Local databases: ArangoDB, PostgreSQL, Redis
      - Docker Compose for deployments
      - SSH: dev-02 (root, key: ~/.ssh/id_rsa)

  dev_03:
    platform: "Hetzner Cloud CCX23 (65.21.52.58, Helsinki)"
    method: docker_compose
    trigger: "Auto-deploy on push to feature/* branches"
    deployment_paths:
      - "/opt/<project>-feature/ (feature branch deployments)"
    compose_file: "docker-compose.integration.yml"
    databases:
      - "ArangoDB (local)"
      - "PostgreSQL (local)"
      - "Redis (local)"
    infrastructure:
      runtime: "Docker + Docker Compose"
      web_server: "Nginx (reverse proxy + SSL via Let's Encrypt)"
      gitlab_runner: "NONE — runner is on dev-01"
    notes: |
      - TERTIARY DEV (dev-03) — feature branches and experiments
      - Hosts: FlowMaster (feature branches, experiments)
      - Local databases: ArangoDB, PostgreSQL, Redis
      - Docker Compose for deployments
      - SSH: dev-03 (root, key: ~/.ssh/demo_server)

  prod_01:
    platform: "Hetzner Cloud CPX41 (91.99.237.14, Nuremberg)"
    method: docker_compose
    url: "https://app.flow-master.ai"
    trigger: "MANUAL approval required (when: manual in GitLab CI)"
    deployment_paths:
      - "/opt/flowmaster-microservices/"
      - "/opt/<project>/ (new projects)"
    domain: "app.flow-master.ai"
    compose_file: "docker-compose.integration.yml"
    approval_required: true
    infrastructure:
      runtime: "Docker + Docker Compose"
      web_server: "Nginx (reverse proxy + SSL via Let's Encrypt)"
      other: "Dokku, Portainer (9443)"
    notes: |
      - PRODUCTION (prod-01) — main branch manual deploy only
      - Hosts: FlowMaster (production)
      - Also used as personal dev server (SSH alias: prod-01/prod-01-root)
      - SSH: prod-01 (ben) or prod-01-root (root), key: ~/.ssh/eron1703_duckdns
      - Projects dir for manual work: /srv/projects/

  local:
    method: docker_compose
    trigger: "Manual: docker compose up"
    notes: "Local development via OrbStack on macOS (NOT Docker Desktop)"

# Secrets Management
secrets:
  # production:
  #   method: aws_secrets_manager | vault | github_secrets
  #   access: "See documentation in docs/secrets.md"
  #
  # staging:
  #   method: environment_variables
  #   access: "Set in CI/CD platform"

  local:
    method: .env files
    notes: "Each project has .env file (gitignored)"
    example: |
      # .env example
      ARANGO_PASSWORD=your_password_here
      API_KEY=your_api_key_here

# Monitoring & Alerts
monitoring:
  flowmaster_dev_01:
    platform: "Grafana + Prometheus + Loki"
    grafana_url: "http://65.21.153.235:30080"
    deployment: "Kubernetes (monitoring namespace)"
    dashboards:
      - "API Performance"
      - "Container Resources"
      - "Infrastructure Metrics"
      - "Application Logs (via Loki)"
    access: "Direct browser access, no auth required for viewing"
    notes: "Monitors FlowMaster microservices on dev-01"

  plane_pm:
    platform: "Plane CE"
    url: "http://65.21.153.235:8083"
    deployment: "Docker Compose + Kubernetes"
    workspace: "flowmaster"
    project: "FM (FlowMaster)"
    mcp_server: "http://65.21.153.235:8012"
    notes: "Project management and task tracking for FlowMaster team"

# Best Practices
best_practices:
  - "Never commit secrets to git"
  - "Use environment variables for configuration"
  - "Test CI/CD changes in feature branches"
  - "Require code review before deployment"
  - "Have rollback plan for production deploys"
